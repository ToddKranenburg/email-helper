<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Email Helper</title>
    <link rel="icon" type="image/png" href="/favicon.png" />
  <style>
    :root {
      color-scheme: light;
      --bg: #f5f6fb;
      --border: #e4e7f0;
      --muted: #6b7280;
      --text: #0f172a;
      --accent: #4338ca;
      --accent-soft: #e0e7ff;
      --chip: #eef2ff;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: "Inter", ui-sans-serif, system-ui;
      margin:0;
      padding:32px;
      background:var(--bg);
      color:var(--text);
    }
    header {
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:20px;
    }
    .btn {
      padding:8px 14px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      cursor:pointer;
      text-decoration:none;
      color:var(--text);
      font-weight:500;
    }

    .workspace-shell {
      display:flex;
      gap:32px;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom:32px;
    }
    .workspace-main {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:24px;
      min-width:0;
    }
    .assistant-workspace {
      background:#fff;
      border:1px solid var(--border);
      border-radius:20px;
      padding:24px;
      box-shadow:0 10px 40px rgba(15,23,42,0.08);
      margin-bottom:0;
      display:flex;
      flex-direction:column;
      gap:20px;
    }
    .email-context {
      flex:0 0 360px;
      max-width:420px;
      width:100%;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .context-intro {
      font-size:14px;
      color:var(--muted);
      background:#f8fafc;
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
    }
    .secretary-message {
      font-size:16px;
      margin:0;
      color:var(--text);
      line-height:1.4;
    }
    .context-stack {
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .context-section {
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      background:#fff;
    }
    .context-section h4 {
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--muted);
      margin:0 0 10px 0;
    }
    .context-person {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .context-avatar {
      width:44px;
      height:44px;
      border-radius:12px;
      background:var(--chip);
      color:var(--accent);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
      font-size:18px;
    }
    .context-from {
      font-weight:600;
      font-size:16px;
      margin:0;
    }
    .context-meta {
      font-size:13px;
      color:var(--muted);
      margin-top:2px;
    }
    .context-subject {
      margin:12px 0 4px;
      font-weight:600;
      font-size:15px;
      color:var(--text);
    }
    .context-chips {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .chip {
      background:var(--chip);
      border-radius:999px;
      padding:4px 12px;
      font-size:12px;
      font-weight:600;
      color:#4338ca;
    }
    .chip-muted {
      background:#f2f4f7;
      color:var(--muted);
    }
    .context-section p {
      margin:0;
      color:#1f2937;
      line-height:1.5;
    }
    .preview-body {
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:#f8fafc;
      min-height:90px;
      font-size:13px;
      color:#1f2937;
      line-height:1.5;
      white-space:pre-line;
      overflow:hidden;
      position:relative;
    }
    .preview-body.collapsed {
      max-height:120px;
    }
    .preview-body.collapsed::after {
      content:"";
      position:absolute;
      inset:auto 0 0 0;
      height:40px;
      background:linear-gradient(180deg, rgba(248,250,252,0) 0%, #f8fafc 100%);
    }
    .preview-actions {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
      gap:12px;
      flex-wrap:wrap;
    }
    .preview-btn {
      border:none;
      background:none;
      color:var(--accent);
      font-weight:600;
      cursor:pointer;
      padding:0;
    }
    .secretary-link {
      text-decoration:none;
      color:var(--text);
      font-weight:600;
      border-bottom:1px solid rgba(15,23,42,0.2);
    }
    .assistant-pane {
      flex:1;
      border:1px solid var(--border);
      border-radius:20px;
      padding:20px;
      background:#fbfcff;
      display:flex;
      flex-direction:column;
      gap:16px;
      min-height:420px;
    }
    .conversation-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--border);
      padding-bottom:12px;
      gap:16px;
    }
    .conversation-title {
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .conversation-title span:first-child {
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    .conversation-count {
      font-weight:600;
      font-size:15px;
      color:var(--text);
    }
    .conversation-controls {
      display:flex;
      gap:8px;
    }
    .workspace-btn {
      border-radius:999px;
      border:1px solid transparent;
      padding:8px 16px;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      transition:opacity 0.15s ease;
    }
    .workspace-btn:disabled { opacity:0.5; cursor:not-allowed; }
    .workspace-btn.ghost {
      border-color:var(--border);
      background:#fff;
      color:var(--text);
    }
    .workspace-btn.primary {
      background:var(--accent);
      color:#fff;
    }
    .assistant-chat-scroll {
      flex:1;
      overflow-y:auto;
      padding-right:4px;
    }
    .assistant-composer {
      border-top:1px solid var(--border);
      padding-top:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      background:linear-gradient(180deg, rgba(251,252,255,0) 0%, #fbfcff 35%, #fbfcff 100%);
    }
    .chat-stream {
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .chat-placeholder-card {
      border:1px dashed var(--border);
      border-radius:16px;
      padding:20px;
      background:#fff;
      font-size:14px;
      color:var(--muted);
    }
    .chat-message {
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .chat-message.assistant .chat-card {
      background:#fff;
      border:1px solid #dfe4ff;
      border-radius:16px;
      padding:14px;
      line-height:1.5;
      box-shadow:0 4px 14px rgba(67,56,202,0.08);
    }
    .chat-message.assistant.typing .chat-card {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .chat-message.user {
      align-items:flex-start;
    }
    .chat-message.user .chat-card {
      background:#101828;
      color:#fff;
      border-radius:16px;
      padding:12px 16px;
      margin-left:auto;
      max-width:70%;
    }
    .chat-card strong { display:block; margin-bottom:6px; }
    .chat-card p { margin:0 0 8px 0; }
    .chat-card p:last-child { margin-bottom:0; }
    .chat-message .meta-text {
      font-size:12px;
      color:var(--muted);
    }
    .typing-dots {
      display:flex;
      gap:4px;
      align-items:center;
    }
    .typing-dot {
      width:6px;
      height:6px;
      border-radius:50%;
      background:#a5b4fc;
      opacity:0.6;
      animation:typing-dot 1.2s infinite ease-in-out;
    }
    .typing-dot:nth-child(2) { animation-delay:0.2s; }
    .typing-dot:nth-child(3) { animation-delay:0.4s; }
    .typing-label {
      font-size:12px;
      color:var(--muted);
      font-weight:500;
    }
    .draft-panel {
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .draft-panel-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
      font-size:14px;
    }
    .draft-controls {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .draft-controls button {
      border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      padding:4px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .draft-editor {
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      min-height:120px;
      font-family:"SFMono-Regular", "Segoe UI Mono", ui-monospace, monospace;
      resize:vertical;
    }
    .workspace-input {
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 18px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      box-shadow:none;
      width:100%;
    }
    .workspace-input textarea {
      flex:1;
      border:none;
      resize:none;
      font-size:15px;
      font-family:inherit;
      line-height:1.4;
      min-height:20px;
      max-height:120px;
      background:transparent;
    }
    .workspace-input textarea:focus { outline:none; }
    .workspace-input button {
      border:none;
      background:var(--text);
      color:#fff;
      padding:10px 18px;
      border-radius:999px;
      font-weight:600;
      cursor:pointer;
    }
    .input-shortcut {
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .input-meta {
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:var(--muted);
      padding:0 6px;
      flex-wrap:wrap;
      gap:8px;
    }
    .chat-error { color:#b91c1c; }
    .ingest-error {
      color:#b91c1c;
      font-size:13px;
      margin:8px 0 0;
    }

    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(420px,1fr));
      gap:12px;
    }
    .card {
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow:0 6px 20px rgba(15,23,42,0.05);
    }
    .brief-container { width:100%; margin-bottom:0; }
    .brief-card {
      background:#fffef5;
      border-color:#f6e3c5;
      box-shadow:0 12px 30px rgba(161,98,7,0.12);
    }
    .brief-label { text-transform:uppercase; font-size:11px; letter-spacing:0.08em; color:#a16207; margin-bottom:4px; display:inline-block; }
    .brief-title { font-size:20px; font-weight:700; margin-bottom:8px; color:#713f12; }
    .brief-highlights { margin:8px 0 0 18px; padding:0; color:#4b5563; list-style:disc; }
    .brief-highlights li { margin-bottom:6px; }
    .brief-highlights a.brief-link {
      color:inherit;
      text-decoration:none;
      border-bottom:1px dashed transparent;
      cursor:pointer;
      transition:color 0.15s ease, border-color 0.15s ease;
    }
    .brief-highlights a.brief-link:hover,
    .brief-highlights a.brief-link:focus-visible {
      color:#1d4ed8;
      border-bottom-color:rgba(59,130,246,0.45);
      outline:none;
    }
    .brief-link-icon {
      font-size:0.8em;
      margin-left:4px;
      opacity:0.45;
      transition:opacity 0.15s ease;
    }
    .brief-highlights a.brief-link:hover .brief-link-icon,
    .brief-highlights a.brief-link:focus-visible .brief-link-icon {
      opacity:0.85;
    }
    .superhead { display:flex; align-items:center; gap:6px; color:#555; font-size:12px; letter-spacing:0.02em; margin-bottom:4px; }
    .emoji { line-height:1; }
    .headline { font-weight:700; font-size:16px; margin-bottom:6px; }
    .subject { font-weight:600; margin-bottom:6px; }
    .meta { color:#666; font-size:12px; margin:2px 0; }
    .label { color:#444; font-weight:600; }
    .next { color:#333; font-weight:500; }
    .pagination { margin-top:16px; display:flex; flex-direction:column; gap:8px; }
    .pagination-inner { display:flex; flex-wrap:wrap; gap:12px; justify-content:space-between; align-items:center; }
    .pagination-status { font-size:14px; color:#374151; font-weight:500; }
    .pagination-page { font-size:12px; color:#6b7280; }
    .pagination-controls { display:flex; gap:8px; }
    .pagination-btn { padding:6px 12px; border-radius:8px; border:1px solid #d1d5db; background:#fff; color:#1f2937; text-decoration:none; font-size:14px; font-weight:500; }
    .pagination-btn.disabled { border-color:#e5e7eb; color:#9CA3AF; cursor:not-allowed; }
    .pagination-note { font-size:12px; color:#6b7280; margin:0; }

    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .hidden { display:none !important; }

    .loading-backdrop {
      position: fixed; inset: 0;
      background: rgba(255,255,255,0.75);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 48px; height: 48px;
      border: 3px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg) } }
    @keyframes typing-dot {
      0%, 80%, 100% {
        transform: scale(0.6);
        opacity: 0.4;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
    .loading-text { margin-top: 12px; color:#444; font-size:14px; text-align:center; }
    .loading-wrap { display:flex; flex-direction:column; align-items:center; }
  </style>
</head>
<body>
  <header>
    <a class="btn" href="/dashboard">Dashboard</a>
    <form id="ingest-form" action="/ingest" method="post"><button class="btn" type="submit">Ingest Inbox (30d)</button></form>
    <p id="ingest-error" class="ingest-error hidden" role="alert"></p>
  </header>

  <!--CONTENT-->

  <!-- Loading overlay -->
  <div id="loading" class="loading-backdrop hidden" aria-live="polite" aria-busy="true">
    <div class="loading-wrap">
      <div class="spinner" role="status" aria-label="Loading"></div>
      <div class="loading-text">Fetching latest inboxâ€¦</div>
    </div>
  </div>

<script>
  // Centralized ingest submission so we can hide spinner on failures.
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('ingest-form');
    const overlay = document.getElementById('loading');
    const errorBox = document.getElementById('ingest-error');
    let ingestInFlight = false;

    async function triggerIngest() {
      if (!form || ingestInFlight) return;
      ingestInFlight = true;
      if (errorBox) {
        errorBox.textContent = '';
        errorBox.classList.add('hidden');
      }
      if (overlay) overlay.classList.remove('hidden');
      try {
        const resp = await fetch(form.action || '/ingest', { method: 'POST', credentials: 'same-origin' });
        if (resp.ok) {
          if (resp.redirected && resp.url) {
            window.location.href = resp.url;
          } else {
            window.location.reload();
          }
          return;
        }
        const message = (await resp.text().catch(() => '')).trim();
        throw new Error(message || 'Unable to sync your Gmail inbox right now. Please try again.');
      } catch (err) {
        console.error('Inbox ingest failed', err);
        if (overlay) overlay.classList.add('hidden');
        if (errorBox) {
          errorBox.textContent = err instanceof Error ? err.message : 'Unable to sync your Gmail inbox right now. Please try again.';
          errorBox.classList.remove('hidden');
        }
      } finally {
        ingestInFlight = false;
      }
    }

    if (form) {
      form.addEventListener('submit', function (event) {
        event.preventDefault();
        triggerIngest();
      });
    }

    // Auto-ingest after first render if server says we're empty (first-time auth)
    if (window.AUTO_INGEST && form) {
      // Give the DOM a tick to paint the existing UI, then trigger ingest.
      requestAnimationFrame(() => {
        triggerIngest();
      });
    }
  });
</script>

</body>
</html>
